# These environment variables must be set in CircleCI UI
#
# AMO_USER       - api user from addons.mozilla.com
# AMO_SECRET     - api key secret from addons.mozilla.com

machine:
  environment:
    DISPLAY: :99
  hosts:
    example.com: 127.0.0.1
  node:
    version: 6.9.1
  python:
    version: 2.7.11

dependencies:

  cache_directories:
    - "addon/node_modules"
    # node_modules is included by default

  override:
    - pip install tox==1.8.1 mozdownload mozinstall
    - google-chrome --version
    - ./bin/circleci/install-node-dependencies.sh
    - ./bin/circleci/setup-test-dependencies.sh
    - ./bin/circleci/build-addon.sh

test:
  pre:
    - mozdownload --version latest --destination firefox.tar.bz2
    - mozinstall firefox.tar.bz2
    - wget -O geckodriver.tar.gz https://github.com/mozilla/geckodriver/releases/download/v0.15.0/geckodriver-v0.15.0-linux64.tar.gz
    - gunzip -c geckodriver.tar.gz | tar xopf -
    - chmod +x geckodriver
    - sudo mv geckodriver /home/ubuntu/bin
    - firefox/firefox --version
    - geckodriver --version
  override:
    - ./bin/circleci/test-addon.sh
    - ./bin/circleci/test-frontend.sh
    - ./bin/circleci/run-integration-tests.sh
  post:
    - bash <(curl -s https://codecov.io/bash)

deployment:

  static_development:
    owner: mozilla
    branch:
      - master
    commands:
      - ./bin/circleci/build-version-json.sh
      - ./bin/circleci/build-frontend.sh
      - TESTPILOT_BUCKET=testpilot.dev.mozaws.net ./bin/deploy.sh dev
      - aws configure set preview.cloudfront true
      - aws cloudfront create-invalidation --distribution-id E2ERG47PHCWD0Z --paths '/*'

# Only notify of builds on master branch.
experimental:
  notify:
    branches:
      only:
        - master
